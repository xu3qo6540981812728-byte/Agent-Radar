<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>房仲開發權威系統 - 五維分析</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231e293b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z'/%3E%3Ccircle cx='12' cy='14' r='4' fill='%23f59e0b' stroke='none'/%3E%3C/svg%3E">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        
   /* 禁止文字選取，保護內容不被複製 */
        body { 
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; 
            -webkit-user-select: none; /* Chrome/Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE10+ */
            user-select: none;         /* Standard */
        }
        /* 允許輸入框可以選取，不然無法輸入 */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } 
        .animate-fade-in { animation: fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. 禁止右鍵選單
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                // alert("系統保護中，已停用右鍵功能。"); // 想要跳出警告可以把這行註解拿掉
            });

            // 2. 禁止鍵盤快捷鍵 (F12, Ctrl+Shift+I, Ctrl+C, Ctrl+U)
            document.addEventListener('keydown', function(e) {
                // 檢查是否按下 Ctrl (Mac是Command)
                const isCmdOrCtrl = (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey);

                // 禁止 F12
                if (e.key === 'F12') {
                    e.preventDefault();
                }
                
                // 禁止 Ctrl+Shift+I (開發者工具)
                if (isCmdOrCtrl && e.shiftKey && (e.key === 'I' || e.key === 'i')) {
                    e.preventDefault();
                }

                // 禁止 Ctrl+U (檢視原始碼)
                if (isCmdOrCtrl && (e.key === 'U' || e.key === 'u')) {
                    e.preventDefault();
                }
                
                // 禁止 Ctrl+C (複製) - 雖然CSS已鎖選取，這層是雙重保險
                if (isCmdOrCtrl && (e.key === 'C' || e.key === 'c')) {
                    e.preventDefault();
                    // alert("內容受到版權保護，禁止複製。");
                }
            });
        });
    </script>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ---------------------------------------------------------
        // 1. Firebase 設定 (請填入你 course.html 裡面的設定)
        // ---------------------------------------------------------
        const firebaseConfig = {
  apiKey: "AIzaSyAZA4RPa_QCGxEBIQgOA13Guv8qSi-hObE",
  authDomain: "agent-radar.firebaseapp.com",
  projectId: "agent-radar",
  storageBucket: "agent-radar.firebasestorage.app",
  messagingSenderId: "265660005518",
  appId: "1:265660005518:web:25a60b610e97f03b519ddf",

};

        // 初始化 Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ---------------------------------------------------------
        // 2. UI 元件 (圖示與圖表) - 保持原樣
        // ---------------------------------------------------------
        const IconUser = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>);
        const IconActivity = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>);
        const IconHome = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>);
        const IconDollarSign = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>);
        const IconUsers = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 5.74"/></svg>);
        const IconBrain = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 5a3 3 0 1 0-7.75 2h-.1A2 2 0 0 0 2 9.25v.1A3 3 0 1 0 7 15h.1A2 2 0 0 0 9.25 18H9.4A3 3 0 1 0 15 22.9V23H15A3 3 0 1 0 22 18.25v-.1A3 3 0 1 0 17 12h-.1A2 2 0 0 0 14.75 9H14.6A3 3 0 1 0 9 4.1V4H9A3 3 0 1 0 4.09 9.38"/><path d="M12 15v5"/><path d="M15 17.5l-3 3.5"/><path d="M9 17.5l3 3.5"/></svg>);
        const IconRefreshCcw = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 8.4V2h-6.4M2 15.6V22h6.4"/><path d="M20 10c0 4.4-3.6 8-8 8s-8-3.6-8-8c0-2.9 1.5-5.6 4-7"/><path d="M13 2H8.4A10 10 0 0 0 3.7 18.2"/><path d="M11 22h4.6A10 10 0 0 0 20.3 5.8"/></svg>);
        const IconChevronRight = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>);
        const IconChevronLeft = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>);
        const IconCheckCircle = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>);
        const IconTarget = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>);
        const IconSave = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>);
        const IconList = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>);
        const IconLogOut = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>);
const IconTrash = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>);
        // DIMENSIONS 資料維持不變
        const DIMENSIONS = {
          personality: { title: "維度一：性格特質", icon: <IconUser className="w-6 h-6" />, desc: "決定溝通頻率、語氣與心理攻防的切入點", options: [ { id: 'tiger', label: '老虎型 (掌控型)', desc: '語速快、聲音大、常打斷、喜下指令、只問結果' }, { id: 'owl', label: '貓頭鷹型 (分析型)', desc: '重細節、愛筆記、比對資料、重法規、情感冷靜' }, { id: 'peacock', label: '孔雀型 (社交型)', desc: '熱情愛聊、肢體豐富、重面子、喜聽好話、情緒化' }, { id: 'koala', label: '無尾熊型 (和平型)', desc: '慢條斯里、猶豫不決、常問家人、怕衝突、配合度高' } ] },
          motivation: { title: "維度二：售屋動機", icon: <IconActivity className="w-6 h-6" />, desc: "判斷急迫性與痛點，決定談判籌碼的大小", options: [ { id: 'change', label: '換屋需求型', desc: '換大換小或工作調動，有明確時間表與剛性需求' }, { id: 'cash', label: '急需資金型', desc: '解決債務或周轉，急迫性最高，痛點最明顯' }, { id: 'asset', label: '閒置去化型', desc: '繼承或多餘資產，無急迫壓力，理性配置考量' }, { id: 'test', label: '試探水溫型', desc: '單純賣賣看，心態隨緣，價格不漂亮就不賣' } ] },
          ownerType: { title: "維度三：屋主種類", icon: <IconUsers className="w-6 h-6" />, desc: "判斷決策模式是偏向「情感價值」還是「數據邏輯」", options: [ { id: 'normal', label: '一般客', desc: '普通民眾，情感連結深，易受「稟賦效應」影響' }, { id: 'investor', label: '投資客', desc: '經驗豐富，看重投報率與成本，決策理性' } ] },
          condition: { title: "維度四：房屋條件", icon: <IconHome className="w-6 h-6" />, desc: "判斷產品本身的優劣勢與市場定位", options: [ { id: 'perfect', label: '完美屋況 (A案)', desc: '無需整理即可入住，賣相極佳，市場接受度高' }, { id: 'needsWork', label: '需整理 (B案)', desc: '需小修補或粉刷，結構無虞，需靠軟裝或想像力銷售' }, { id: 'flaw', label: '瑕疵較多 (C案)', desc: '路沖、凶宅或屋況極差，客群受限，需特殊通路' }, { id: 'complex', label: '條件複雜 (客製)', desc: '產權複雜或格局極度特殊，需專業法務或特殊買方' } ] },
          price: { title: "維度五：價格狀況", icon: <IconDollarSign className="w-6 h-6" />, desc: "判斷屋主對行情的認知偏差程度", options: [ { id: 'market', label: '市場價 (行情)', desc: '符合實價登錄，合理區間，成交阻力最小' }, { id: 'high', label: '尚可價 (略高)', desc: '略高於行情，預留議價空間，屬正常心態' }, { id: 'challenge', label: '挑戰價 (極高)', desc: '明顯高於行情，憑藉屋況或情感開價，需時間磨合' }, { id: 'urgent', label: '急售價 (低於行情)', desc: '低於行情，尋求快速成交，通常伴隨強烈動機' } ] },
          contract: { title: "特別加權：委託型態", icon: <IconTarget className="w-6 h-6" />, desc: "決定案件的掌控權與成交的安全係數", options: [ { id: 'general', label: '一般委託 (多窗)', desc: '競爭激烈，資訊混雜，無法掌控同業動態，成交不一定在自己手上' }, { id: 'exclusive', label: '專任委託 (單一)', desc: '單一窗口，屋主接收資訊單純，擁有完整議價權與佈局時間，成交機率極高' } ] }
        };

        // RadarChart 元件 (維持不變)
        const RadarChart = ({ radarData }) => {
            const dimensionKeys = Object.keys(DIMENSIONS);
            const count = dimensionKeys.length;
            const size = 240;
            const center = size / 2;
            const radius = 90;
            const angleStep = (Math.PI * 2) / count;
            const labels = ["性格", "動機", "屋主", "屋況", "價格", "委託"];
            const points = radarData.map((val, i) => {
                const normalized = val / 100;
                const angle = i * angleStep - Math.PI / 2;
                const r = normalized * radius;
                return `${center + r * Math.cos(angle)},${center + r * Math.sin(angle)}`;
            }).join(' ');
            const gridPolygons = [20, 40, 60, 80, 100].map(level => {
                return Array.from({ length: count }).map((_, i) => {
                    const angle = i * angleStep - Math.PI / 2;
                    const r = (level / 100) * radius;
                    return `${center + r * Math.cos(angle)},${center + r * Math.sin(angle)}`;
                }).join(' ');
            });
            const labelCoords = Array.from({ length: count }).map((_, i) => {
                const angle = i * angleStep - Math.PI / 2;
                const r = radius + 25;
                return { x: center + r * Math.cos(angle), y: center + r * Math.sin(angle), text: labels[i] };
            });
            return (
                <div className="flex flex-col items-center">
                <svg width={size + 80} height={size + 40} viewBox={`0 0 ${size + 80} ${size + 40}`}>
                    <g transform="translate(40, 20)">
                    {gridPolygons.map((pts, i) => ( <polygon key={i} points={pts} fill={i === 4 ? "#f8fafc" : "none"} stroke="#cbd5e1" strokeWidth="1" strokeDasharray={i < 4 ? "4 4" : ""} /> ))}
                    {Array.from({ length: count }).map((_, i) => {
                        const angle = i * angleStep - Math.PI / 2;
                        const x = center + radius * Math.cos(angle);
                        const y = center + radius * Math.sin(angle);
                        return <line key={i} x1={center} y1={center} x2={x} y2={y} stroke="#e2e8f0" strokeWidth="1" />;
                    })}
                    <polygon points={points} fill="rgba(245, 158, 11, 0.5)" stroke="#d97706" strokeWidth="3" />
                    {radarData.map((val, i) => {
                        const normalized = val / 100;
                        const angle = i * angleStep - Math.PI / 2;
                        const r = normalized * radius;
                        return <circle key={i} cx={center + r * Math.cos(angle)} cy={center + r * Math.sin(angle)} r="4" fill="#d97706" stroke="white" strokeWidth="2" />;
                    })}
                    {labelCoords.map((l, i) => ( <text key={i} x={l.x} y={l.y} textAnchor="middle" dominantBaseline="middle" fontSize="12" fill="#475569" fontWeight="bold">{l.text}</text> ))}
                    </g>
                </svg>
                <div className="text-xs text-slate-400 mt-[-10px]">面積越大 = 掌控度越高</div>
                </div>
            );
        };

        const { useState, useEffect } = React;
const Watermark = ({ text }) => {
           
            const displayAccount = text ? text.split('@')[0] : '';
            
            return (
                <div className="fixed inset-0 pointer-events-none z-[9999] overflow-hidden" style={{ opacity: 0.08 }}>
                    <svg width="100%" height="100%">
                        <defs>
                            <pattern id="watermark-pattern" x="0" y="0" width="300" height="300" patternUnits="userSpaceOnUse">
                                <text 
                                    x="150" 
                                    y="150" 
                                    fontSize="20" 
                                    fill="#000" 
                                    transform="rotate(-30, 150, 150)" 
                                    textAnchor="middle" 
                                    dominantBaseline="middle" 
                                    fontWeight="bold"
                                    fontFamily="sans-serif"
                                >
                                    {displayAccount}
                                </text>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#watermark-pattern)" />
                    </svg>
                </div>
            );
        };

        // ---------------------------------------------------------
        // 新增功能：統一的頁尾版權宣告
        // ---------------------------------------------------------
        const Footer = () => (
            <footer className="text-center py-8 text-slate-400 text-xs md:text-sm mt-auto border-t border-slate-200/50 bg-slate-50/50 backdrop-blur-sm">
                <p>Copyright © 2025 李培智. All Rights Reserved.</p>
            </footer>
        );
        // ---------------------------------------------------------
        // 3. Login Component (登入畫面)
        // ---------------------------------------------------------
        function Login({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                
                const emailToUse = username.trim() + "@agent.system"; 

                try {
                    await auth.signInWithEmailAndPassword(emailToUse, password);
                    // 登入成功
                } catch (err) {
                    console.error(err);
                    setError("登入失敗：帳號或密碼錯誤");
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 text-center">房仲開發權威系統</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-slate-700">帳號</label>
                                <input 
                                    type="text" 
                                    required 
                                    value={username} 
                                    onChange={(e) => setUsername(e.target.value.toUpperCase())} // 自動轉大寫，避免大小寫輸入錯誤
                                    placeholder="員工編號"
                                    className="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 uppercase" 
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-slate-700">密碼</label>
                                <input 
                                    type="password" 
                                    required 
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)} 
                                    className="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500" 
                                />
                            </div>
                            {error && <p className="text-red-500 text-sm text-center font-bold">{error}</p>}
                            <button type="submit" className="w-full bg-amber-500 text-white p-3 rounded-lg font-bold hover:bg-amber-600 transition">登入系統</button>
                        </form>
                    </div>
                </div>
            );
        }

        // ---------------------------------------------------------
        // 4. Dashboard Component (委託列表清單)
        // ---------------------------------------------------------
        function Dashboard({ user, onCreateNew, onViewReport }) {
            const [records, setRecords] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = db.collection('analyses')
                    .where('userId', '==', user.uid)
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setRecords(docs);
                        setLoading(false);
                    });
                return () => unsubscribe();
            }, [user]);

            // ★★★ 新增刪除功能 ★★★
            const handleDelete = async (docId, name) => {
                // 1. 跳出確認視窗 (防呆)
                const isConfirmed = confirm(`警告：您確定要永久刪除「${name}」這筆分析嗎？\n此動作無法復原！`);
                
                if (isConfirmed) {
                    try {
                        // 2. 執行 Firebase 刪除指令
                        await db.collection('analyses').doc(docId).delete();
                        alert("刪除成功！");
                        // 不需要手動更新 records，因為上面的 onSnapshot 會自動偵測並更新畫面
                    } catch (error) {
                        console.error("刪除失敗:", error);
                        alert("刪除失敗，請稍後再試。");
                    }
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col relative">
                    <Watermark text={user.email} />

                    <div className="p-4 md:p-8 flex-grow relative z-10">
                        <div className="max-w-5xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <h1 className="text-3xl font-bold text-slate-800">我的委託分析庫</h1>
                                <div className="flex gap-4">
                                    <button onClick={onCreateNew} className="bg-amber-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-amber-600 flex items-center shadow-md">
                                        <IconBrain className="w-5 h-5 mr-2"/> 新增分析
                                    </button>
                                    <button onClick={() => auth.signOut()} className="bg-white text-slate-600 px-4 py-2 rounded-lg font-bold border border-slate-200 hover:bg-slate-100 flex items-center">
                                        <IconLogOut className="w-5 h-5 mr-2"/> 登出
                                    </button>
                                </div>
                            </div>

                            {loading ? (
                                <div className="text-center py-20 text-slate-500">載入中...</div>
                            ) : records.length === 0 ? (
                                <div className="bg-white rounded-2xl p-10 text-center shadow-sm border border-slate-100">
                                    <p className="text-slate-500 mb-4">目前還沒有分析紀錄</p>
                                    <button onClick={onCreateNew} className="text-amber-500 font-bold hover:underline">立即建立第一筆分析</button>
                                </div>
                            ) : (
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead className="bg-slate-50 border-b border-slate-200">
                                                <tr>
                                                    <th className="p-4 font-bold text-slate-600">日期</th>
                                                    <th className="p-4 font-bold text-slate-600">委託名稱</th>
                                                    <th className="p-4 font-bold text-slate-600">編號</th>
                                                    <th className="p-4 font-bold text-slate-600">評分</th>
                                                    <th className="p-4 font-bold text-slate-600 text-right">操作</th>
                                                    {/* 新增一欄給刪除按鈕 */}
                                                    <th className="p-4 w-10"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {records.map(rec => (
                                                    <tr key={rec.id} className="hover:bg-slate-50 transition group">
                                                        <td className="p-4 text-sm text-slate-500">{rec.createdAt?.toDate().toLocaleDateString()}</td>
                                                        <td className="p-4 font-bold text-slate-800">{rec.delegationName}</td>
                                                        <td className="p-4 text-slate-600">{rec.delegationId}</td>
                                                        <td className="p-4">
                                                            <span className={`font-bold ${rec.apiResult.score >= 80 ? 'text-amber-500' : rec.apiResult.score >= 60 ? 'text-blue-600' : 'text-slate-500'}`}>
                                                                {rec.apiResult.score}
                                                            </span>
                                                        </td>
                                                        <td className="p-4 text-right">
                                                            <button onClick={() => onViewReport(rec)} className="text-indigo-600 hover:text-indigo-800 font-bold text-sm">
                                                                查看報告
                                                            </button>
                                                        </td>
                                                        {/* ★★★ 刪除按鈕 ★★★ */}
                                                        <td className="p-4 text-right">
                                                            <button 
                                                                onClick={() => handleDelete(rec.id, rec.delegationName)} 
                                                                className="text-red-300 hover:text-red-600 transition p-2 rounded-full hover:bg-red-50"
                                                                title="刪除此筆資料"
                                                            >
                                                                <IconTrash className="w-4 h-4" />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <Footer />
                </div>
            );
        }
        // ---------------------------------------------------------
        // 5. Main Logic Component (原有的分析邏輯 + 存檔功能)
        // ---------------------------------------------------------
        function AgentAuthoritySystemRadar({ user, onBack, initialData }) {
          // 狀態管理：如果 initialData 存在(查看模式)，則直接顯示結果
          const isViewMode = !!initialData;
          
          // 基本欄位 (Metadata)
          const [meta, setMeta] = useState({
              delegationName: initialData?.delegationName || '',
              delegationId: initialData?.delegationId || '',
              delegationLink: initialData?.delegationLink || ''
          });

          // 分析選項
          const [selections, setSelections] = useState(initialData?.selections || {
            personality: '', motivation: '', ownerType: '', condition: '', price: '', contract: ''
          });
          
          const [currentStep, setCurrentStep] = useState(0);
          const [showResult, setShowResult] = useState(isViewMode);
          const [isLoading, setIsLoading] = useState(false);
          const [apiResult, setApiResult] = useState(initialData?.apiResult || null);
          const [isSaving, setIsSaving] = useState(false);

          const dimensionKeys = Object.keys(DIMENSIONS);
          const currentDimensionKey = dimensionKeys[currentStep];
          const currentDimension = DIMENSIONS[currentDimensionKey];

          const handleMetaChange = (e) => {
              const { name, value } = e.target;
              setMeta(prev => ({ ...prev, [name]: value }));
          };

          const handleSelect = (value) => {
            setSelections(prev => ({ ...prev, [currentDimensionKey]: value }));
          };

          const handleNext = async () => {
            if (currentStep < dimensionKeys.length - 1) {
              setCurrentStep(prev => prev + 1);
            } else {
              // 呼叫後端 API
              setIsLoading(true);
              try {
                  const response = await fetch('/.netlify/functions/analyze', {
                      method: 'POST',
                      body: JSON.stringify(selections)
                  });
                  const data = await response.json();
                  setApiResult(data);
                  setShowResult(true);
              } catch (error) {
                  console.error("Error:", error);
                  alert("運算發生錯誤，請稍後再試");
              } finally {
                  setIsLoading(false);
              }
            }
          };

          const handleSave = async () => {
              if (!meta.delegationName) {
                  alert("請輸入委託名稱以便存檔");
                  return;
              }
              setIsSaving(true);
              try {
                  await db.collection('analyses').add({
                      userId: user.uid,
                      delegationName: meta.delegationName,
                      delegationId: meta.delegationId,
                      delegationLink: meta.delegationLink,
                      selections: selections,
                      apiResult: apiResult,
                      createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  alert("存檔成功！");
                  onBack(); // 回到列表
              } catch (error) {
                  console.error(error);
                  alert("存檔失敗：" + error.message);
              } finally {
                  setIsSaving(false);
              }
          };

          const handlePrev = () => {
            if (currentStep > 0) setCurrentStep(prev => prev - 1);
          };

          const getScoreColor = (s) => s >= 80 ? "text-amber-500" : s >= 60 ? "text-blue-600" : "text-slate-500";
          const getScoreComment = (s) => s >= 80 ? "黃金A案 - 團隊必爭之地，全力衝刺！" : s >= 60 ? "潛力B案 - 需透過經營與議價轉化為A案。" : "磨練C案 - 考驗耐性與專業，放長線釣大魚。";

          if (isLoading) {
              return (
                  <div className="min-h-screen flex items-center justify-center bg-slate-50">
                      <div className="text-center">
                          <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-amber-500 mx-auto mb-4"></div>
                          <h2 className="text-xl font-bold text-slate-700">AI 核心運算中...</h2>
                      </div>
                  </div>
              );
          }

          return (
              <div className="min-h-screen bg-slate-50 flex flex-col relative">
                    {/* 1. 插入浮水印 */}
                    <Watermark text={user.email} />
            <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800">
              <div className="max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
                
                {/* Header */}
                <div className="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-6 flex justify-between items-center">
                  <div>
                    <h1 className="text-2xl md:text-3xl font-bold tracking-wider">房仲開發權威系統</h1>
                    <p className="text-slate-400 text-xs md:text-sm mt-1">五維深度運算 ‧ 客觀評分 ‧ 局勢佈局</p>
                  </div>
                  <button onClick={onBack} className="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-sm flex items-center transition">
                     <IconList className="w-4 h-4 mr-2"/> 回列表
                  </button>
                </div>

                {!showResult ? (
                  <div className="p-6 md:p-12">
                    
                    {/* 基本資料輸入區 (只在第一步顯示) */}
                    {currentStep === 0 && (
                                        <div className="mb-8 bg-slate-50 p-6 rounded-xl border border-slate-200">
                                            <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center"><IconList className="w-5 h-5 mr-2"/> 基本資料 (選填)</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">委託名稱 *</label>
                                                    <input type="text" name="delegationName" value={meta.delegationName} onChange={handleMetaChange} placeholder="複製後台案名" className="w-full p-2 border rounded focus:border-amber-500 outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">委託編號</label>
                                                    <input type="text" name="delegationId" value={meta.delegationId} onChange={handleMetaChange} placeholder="例：AA12345678" className="w-full p-2 border rounded focus:border-amber-500 outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 mb-1">物件連結</label>
                                                    <input type="text" name="delegationLink" value={meta.delegationLink} onChange={handleMetaChange} placeholder="http://..." className="w-full p-2 border rounded focus:border-amber-500 outline-none" />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex justify-between mb-2 px-1">
                                      <span className="text-xs font-bold text-slate-400">STEP {currentStep + 1}</span>
                                      <span className="text-xs font-bold text-slate-400">TOTAL {dimensionKeys.length}</span>
                                    </div>
                                    <div className="w-full bg-slate-100 h-2 rounded-full mb-8 overflow-hidden">
                                      <div className="bg-amber-500 h-full transition-all duration-500 ease-out" style={{ width: `${((currentStep + 1) / dimensionKeys.length) * 100}%` }}></div>
                                    </div>

                                    <div className="mb-10 min-h-[300px]">
                                      <div className="flex flex-col md:flex-row md:items-center mb-6 gap-4">
                                        <div className="w-12 h-12 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center shadow-sm flex-shrink-0">
                                          {currentDimension.icon}
                                        </div>
                                        <div>
                                          <h2 className="text-2xl font-bold text-slate-800">{currentDimension.title}</h2>
                                          <p className="text-slate-500 mt-1">{currentDimension.desc}</p>
                                        </div>
                                      </div>

                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {currentDimension.options.map((option) => (
                                          <button
                                            key={option.id}
                                            onClick={() => handleSelect(option.id)}
                                            className={`relative p-5 rounded-xl border-2 text-left transition-all duration-200 hover:shadow-md ${
                                              selections[currentDimensionKey] === option.id ? 'border-amber-500 bg-amber-50 shadow-md' : 'border-slate-100 bg-white hover:border-amber-200'
                                            }`}
                                          >
                                            <div className="flex justify-between items-center mb-2">
                                              <span className={`font-bold text-lg ${selections[currentDimensionKey] === option.id ? 'text-amber-700' : 'text-slate-700'}`}>{option.label}</span>
                                              {selections[currentDimensionKey] === option.id && <IconCheckCircle className="w-5 h-5 text-amber-500" />}
                                            </div>
                                            <p className="text-slate-500 text-sm leading-relaxed">{option.desc}</p>
                                          </button>
                                        ))}
                                      </div>
                                    </div>

                                    <div className="flex justify-between pt-6 border-t border-slate-100">
                                      <button onClick={handlePrev} disabled={currentStep === 0} className={`flex items-center px-5 py-2.5 rounded-lg text-sm font-medium transition-colors ${currentStep === 0 ? 'opacity-0 cursor-default' : 'text-slate-500 hover:bg-slate-100'}`}>
                                        <IconChevronLeft className="w-4 h-4 mr-1" /> 上一步
                                      </button>
                                      <button onClick={handleNext} disabled={!selections[currentDimensionKey]} className={`flex items-center px-8 py-3 rounded-lg font-bold text-base shadow-lg transition-all transform ${!selections[currentDimensionKey] ? 'bg-slate-200 text-slate-400 cursor-not-allowed shadow-none' : 'bg-amber-500 text-white hover:bg-amber-600 hover:-translate-y-0.5 shadow-amber-500/30'}`}>
                                        {currentStep === dimensionKeys.length - 1 ? '開始運算分析' : '下一步'} <IconChevronRight className="ml-1 w-5 h-5" />
                                      </button>
                                    </div>

                                </div>
                             ) : (
                  <div className="animate-fade-in">
                    {/* Result Top Bar */}
                    <div className="bg-slate-50 border-b border-slate-200 p-4">
                      <div className="flex flex-wrap justify-center gap-2 md:gap-4">
                        {dimensionKeys.map(key => {
                          const opt = DIMENSIONS[key].options.find(o => o.id === selections[key]);
                          return (
                            <div key={key} className="bg-white px-3 py-1.5 rounded border border-slate-200 shadow-sm flex flex-col items-center min-w-[100px]">
                              <span className="text-[10px] text-slate-400 font-bold uppercase mb-0.5">{DIMENSIONS[key].title.split('：')[1]}</span>
                              <span className="text-sm font-bold text-slate-700">{opt?.label.split('(')[0]}</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div className="p-6 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8">
                      {/* Left Column */}
                      <div className="lg:col-span-1 space-y-6">
                        {/* 基本資料卡 */}
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
                             <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">委託物件資訊</h4>
                             <h3 className="text-xl font-bold text-slate-800 mb-1">{meta.delegationName || "未命名物件"}</h3>
                             <p className="text-sm text-slate-500 mb-2">編號: {meta.delegationId || "--"}</p>
                             {meta.delegationLink && (
                                 <a href={meta.delegationLink} target="_blank" className="text-amber-500 text-sm hover:underline flex items-center"><IconList className="w-3 h-3 mr-1"/> 開啟連結</a>
                             )}
                        </div>

                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 text-center relative overflow-hidden pb-8">
                          <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-amber-400 to-orange-500"></div>
                          <div className="mt-4 mb-6">
                            <h3 className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">綜合評分</h3>
                            <div className={`text-6xl font-black ${getScoreColor(apiResult.score)}`}>{apiResult.score}</div>
                            <p className="text-slate-600 font-bold text-sm mt-2 px-2">{getScoreComment(apiResult.score)}</p>
                          </div>
                          <div className="border-t border-slate-100 pt-6">
                            <h3 className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-4">委託難易度雷達</h3>
                            <RadarChart radarData={apiResult.radarData} />
                          </div>
                        </div>
                        {/* 存檔按鈕 (僅在新建模式或尚未存檔時顯示，這裡簡化為總是顯示，如果是查看模式可以隱藏) */}
                        {!isViewMode && (
                            <button onClick={handleSave} disabled={isSaving} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all transform flex items-center justify-center ${isSaving ? 'bg-slate-400' : 'bg-green-600 hover:bg-green-700 hover:-translate-y-1'}`}>
                                {isSaving ? '儲存中...' : <><IconSave className="w-5 h-5 mr-2" /> 儲存分析報告</>}
                            </button>
                        )}
                      </div>

                      {/* Right Column */}
                      <div className="lg:col-span-2 space-y-6">
                        <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm hover:shadow-md transition-all">
                          <div className="bg-slate-800 p-4 flex items-center text-white">
                            <IconBrain className="w-5 h-5 mr-3 text-amber-400" /> <h3 className="font-bold text-lg">屋主性格與深層心理攻防</h3>
                          </div>
                          <div className="p-6 md:p-8"><div className="whitespace-pre-wrap text-slate-700 leading-loose">{apiResult.analysis.psychology}</div></div>
                        </div>
                        <div className="bg-white rounded-2xl border border-amber-200 overflow-hidden shadow-sm hover:shadow-md transition-all relative">
                           <div className="absolute top-0 left-0 w-1 h-full bg-amber-400"></div>
                           <div className="p-6 md:p-8">
                            <h3 className="font-bold text-amber-700 mb-3 flex items-center"><IconActivity className="w-5 h-5 mr-2" /> 情緒破冰與接地氣策略</h3>
                            <div className="whitespace-pre-wrap text-slate-700 leading-loose italic bg-amber-50/50 p-4 rounded-lg border border-amber-100">{apiResult.analysis.emotionTip}</div>
                          </div>
                        </div>
                        <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm hover:shadow-md transition-all">
                          <div className="bg-slate-800 p-4 flex items-center text-white"><IconUsers className="w-5 h-5 mr-3 text-blue-400" /> <h3 className="font-bold text-lg">委託局勢與團隊合作策略</h3></div>
                          <div className="p-6 md:p-8"><div className="whitespace-pre-wrap text-slate-700 leading-loose">{apiResult.analysis.teamStrategy}</div></div>
                                        </div>
                                      </div>
                                    </div>
                                </div>
                             )}
                         </div>
                    </div>

                    {/* 2. 插入頁尾 */}
                    <Footer />
                  <style>{`@keyframes fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }`}</style>
                </div>
             );
        }

        // ---------------------------------------------------------
        // 6. Main App (狀態路由管理)
        // ---------------------------------------------------------
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard'); // 'dashboard', 'create', 'view_report'
            const [viewData, setViewData] = useState(null); // 用於查看報告時傳遞資料

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500">系統啟動中...</div>;
            
            // 未登入 -> 顯示 Login
            if (!user) return <Login />;

            // 已登入 -> 根據 view 顯示不同畫面
            if (view === 'create') {
                return <AgentAuthoritySystemRadar user={user} onBack={() => setView('dashboard')} />;
            }
            if (view === 'view_report') {
                return <AgentAuthoritySystemRadar user={user} onBack={() => setView('dashboard')} initialData={viewData} />;
            }

            // 預設 -> Dashboard
            return <Dashboard 
                user={user} 
                onCreateNew={() => setView('create')} 
                onViewReport={(data) => { setViewData(data); setView('view_report'); }} 
            />;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>







